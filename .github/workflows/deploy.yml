name: Deploy to Linode

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Rsync files to Linode
        uses: easingthemes/ssh-deploy@v5.0.3
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
          ARGS: "-avzr --delete --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r"
          SOURCE: "."
          TARGET: ${{ secrets.REMOTE_TARGET }}
          EXCLUDE: ".git/, .github/, **/.DS_Store, **/Thumbs.db, README.md, deploy/"

      - name: Post-deploy hook (optional)
        if: ${{ success() }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          port: ${{ secrets.REMOTE_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            # Ensure correct permissions for multi-site setup
            if [ -d "${{ secrets.REMOTE_TARGET }}" ]; then
              sudo chown -R deploy:deploy "${{ secrets.REMOTE_TARGET }}"
              find "${{ secrets.REMOTE_TARGET }}" -type f -exec chmod 644 {} \;
              find "${{ secrets.REMOTE_TARGET }}" -type d -exec chmod 755 {} \;
            fi
            
            # Test and reload nginx configuration (safe for multi-site)
            if command -v nginx >/dev/null 2>&1; then
              if sudo nginx -t; then
                sudo systemctl reload nginx
                echo "âœ… Nginx reloaded successfully"
              else
                echo "âŒ Nginx configuration test failed - not reloading"
                exit 1
              fi
            fi
            
            # Log deployment
            echo "ðŸš€ Deployment completed at $(date)" >> "${{ secrets.REMOTE_TARGET }}/deploy.log"

